<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>Tray.h</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
// src\Tray.h - systemtray, create and process window messages
#pragma once // Copyright 2023 Alex0vSky (https://github.com/Alex0vSky)
namespace prj_sysw { namespace TinySynapticsScroll { 
class WndProc;
template&lt;class T = WndProc, class T2 = Menu&lt; &gt; &gt;
class Tray {
	// Must be a valid or LoadIcon() == ERROR_RESOURCE_TYPE_NOT_FOUND;
	const HINSTANCE m_hInst;
	const HICON m_hIcon;
	const UINT c_uWM_TASKBAR_CREATE;
	HWND m_hHiddenWnd;
	static const UINT c_uIdTrayIcon = 1;
	NOTIFYICONDATAA m_stNotifyIconData;

	// @insp ...
	template &lt;std::size_t N1, std::size_t N2&gt;
<span style = "background-color:#dfd">	static constexpr void str_chars_(const char (&amp;szSrc)[N1], char (&amp;szDst)[N2]) {</span>
		static_assert( N1 &lt;= N2, "source 'szSrc' string is too long" );
<span style = "background-color:#dfd">		for ( std::size_t i = 0; i &lt; N1 &amp;&amp; i &lt; N2; ++i ) 
			szDst[ i ] = szSrc[ i ];
	}</span>
	
 public:
	explicit Tray(HINSTANCE hInst)
<span style = "background-color:#dfd">		: m_hInst( hInst )
		, m_hIcon( ::LoadIconA( hInst, static_cast&lt;LPCTSTR&gt;( MAKEINTRESOURCEA( IDI_ICON1 ) ) ) )
		, c_uWM_TASKBAR_CREATE( ::RegisterWindowMessageA( "TaskbarCreated" ) )
		, m_hHiddenWnd( nullptr )</span>
		, m_stNotifyIconData{ }
<span style = "background-color:#dfd">    {}</span>
	
<span style = "background-color:#dfd">	bool init(WNDPROC lpfnWndProc, T *poWndProc, const T2 &amp;oMenu) {
		char szClassName[] = "TinySynapticsScrollApplication";
		if ( !m_hIcon ) 
			return false;</span>
		// @insp https://github.com/marek/trayframework/blob/master/trayframework.c
<span style = "background-color:#dfd">		const INITCOMMONCONTROLSEX stIccex = { sizeof( INITCOMMONCONTROLSEX ), ICC_UPDOWN_CLASS | ICC_LISTVIEW_CLASSES };
		if ( !::InitCommonControlsEx( &amp;stIccex ) ) 
			return false;
		WNDCLASSEXA stWc = { };
		stWc.cbSize = sizeof( stWc ); 
		stWc.style = CS_HREDRAW | CS_VREDRAW; 
		stWc.lpfnWndProc = lpfnWndProc;
		stWc.hInstance = m_hInst;
		stWc.hIcon = m_hIcon; 
		stWc.lpszClassName = szClassName;
		stWc.hIconSm = m_hIcon;
		if ( !::RegisterClassExA( &amp;stWc ) )
			return false;</span>

		// Create the hidden window
<span style = "background-color:#dfd">		m_hHiddenWnd = ::CreateWindowExA( </span>
				WS_EX_CLIENTEDGE 
				, szClassName, ""
				, WS_OVERLAPPEDWINDOW
				, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT
				, NULL, NULL, m_hInst
				, poWndProc
			);
<span style = "background-color:#dfd">		if ( !m_hHiddenWnd ) 
			return false;</span>

<span style = "background-color:#dfd">		m_stNotifyIconData = { }; 
		m_stNotifyIconData.cbSize = sizeof( m_stNotifyIconData );
		m_stNotifyIconData.hWnd = m_hHiddenWnd;
		m_stNotifyIconData.uID = c_uIdTrayIcon;
		m_stNotifyIconData.uFlags = NIF_ICON | NIF_MESSAGE | NIF_TIP;
		m_stNotifyIconData.uCallbackMessage = oMenu.getWindowMessageId( );
		m_stNotifyIconData.hIcon = m_hIcon;</span>
#ifdef _DEBUG
<span style = "background-color:#dfd">		str_chars_( "TinySynapticsScroll\nSettings or exit [DEBUG]", m_stNotifyIconData.szTip );</span>
#else
		str_chars_( "TinySynapticsScroll\nSettings or exit", m_stNotifyIconData.szTip );
#endif
		// Display tray icon
<span style = "background-color:#dfd">		if ( !::Shell_NotifyIconA( NIM_ADD, &amp;m_stNotifyIconData ) ) 
			return false;
		return true;
	}
	bool handleWindowMessage(HWND hWnd, UINT uMsg, WPARAM, LPARAM) {</span>
		// Taskbar has been recreated, cause: process explorer.exe has been restarted
<span style = "background-color:#dfd">		if ( uMsg == c_uWM_TASKBAR_CREATE ) { 
			if ( ::Shell_NotifyIconA( NIM_ADD, &amp;m_stNotifyIconData ) ) 
				return true;
			Tool::ErrorHandler::showMsg( "Systray icon recreation" );
			::DestroyWindow( hWnd );</span>
		}
		// Remove Tray Item
<span style = "background-color:#dfd">		if ( WM_DESTROY == uMsg ) {
			::Shell_NotifyIconA( NIM_DELETE, &amp;m_stNotifyIconData );
			m_hHiddenWnd = nullptr;</span>
		}
		// yes, false and pass to caller
<span style = "background-color:#dfd">		return false;
	}
	HWND getHwnd( ) const {
		return m_hHiddenWnd;
	}</span>
	Tray &amp;operator = (const Tray &amp;) = delete;
};
}} // namespace prj_sysw::TinySynapticsScroll _</pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>