<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>Dx12Adapter.h</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
ï»¿// Dx/Adapter/Dx12Adapter.h - work with adapter
#pragma once
namespace prj_3d::HelloWinHlsl::Dx::Adapter {
class Dx12Adapter {
	std::string m_strAdapterDescr;
	CPtr&lt; IDXGIAdapter1 &gt; m_pcDxgiAdapter;
	CPtr&lt; IDXGIFactory6 &gt; m_pcDxgiFactory6;
public:
<span style = "background-color:#fdd">	bool prepare() {
		Sys::Hr hr;
	    UINT dxgiFactoryFlags = 0;</span>
		//* 
#ifdef _DEBUG
		// Enable the debug layer (requires the Graphics Tools "optional feature").
		// NOTE: Enabling the debug layer after device creation will invalidate the active device.
		{
<span style = "background-color:#fdd">			CPtr&lt; ID3D12Debug &gt; D3D12Debug;</span>
			HRESULT hr_;
<span style = "background-color:#fdd">			hr_ = ::D3D12GetDebugInterface( IID_PPV_ARGS( D3D12Debug.ReleaseAndGetAddressOf( ) ) );
			if ( SUCCEEDED( hr_ ) ) {
				D3D12Debug -&gt;EnableDebugLayer( );</span>
				// Enable additional debug layers.
<span style = "background-color:#fdd">				dxgiFactoryFlags |= DXGI_CREATE_FACTORY_DEBUG;</span>
			}
<span style = "background-color:#fdd">		}</span>

		/*
		CPtr&lt; IDXGIInfoQueue &gt; dxgiInfoQueue;
		if (DXGIGetDebugInterface1 != nullptr &amp;&amp; SUCCEEDED(::DXGIGetDebugInterface1(0, IID_PPV_ARGS(dxgiInfoQueue.GetAddressOf()))))
		{
			hr = dxgiInfoQueue-&gt;SetBreakOnSeverity(DXGI_DEBUG_ALL, DXGI_INFO_QUEUE_MESSAGE_SEVERITY_CORRUPTION, true);
			hr = dxgiInfoQueue-&gt;SetBreakOnSeverity(DXGI_DEBUG_ALL, DXGI_INFO_QUEUE_MESSAGE_SEVERITY_ERROR, true);
			//dxgiInfoQueue-&gt;SetBreakOnSeverity(DXGI_DEBUG_ALL, DXGI_INFO_QUEUE_MESSAGE_SEVERITY_WARNING, true);

			DXGI_INFO_QUEUE_MESSAGE_ID hide[] =
			{
				// IDXGISwapChain::GetContainingOutput: The swapchain's adapter does not control the output on which the swapchain's window resides.
				//80 
				// D3D Error 887e0003: (3224@711816656) at 00007FFDDE460ED5
				// D3D12 SDKLayers dll does not match the D3D12SDKVersion of D3D12 Core dll.
				//0x887e0003
				3224
			};
			DXGI_INFO_QUEUE_FILTER filter = {};
			filter.DenyList.NumIDs = static_cast&lt;UINT&gt;(std::size(hide));
			filter.DenyList.pIDList = hide;
			//hr = dxgiInfoQueue-&gt;AddStorageFilterEntries(DXGI_DEBUG_DXGI, &amp;filter);
			D3D12_MESSAGE_ID_DRAW_EMPTY_SCISSOR_RECTANGLE;
			hr = dxgiInfoQueue -&gt;AddStorageFilterEntries( DXGI_DEBUG_ALL, &amp;filter );
		}//*/

#endif // _DEBUG
		//*/
		{
<span style = "background-color:#fdd">			CPtr&lt; IDXGIFactory4 &gt; pcDxgiFactory4;
			hr = ::CreateDXGIFactory2( dxgiFactoryFlags, IID_PPV_ARGS( pcDxgiFactory4.ReleaseAndGetAddressOf( ) ) );
			hr = pcDxgiFactory4 -&gt;QueryInterface( IID_PPV_ARGS( m_pcDxgiFactory6.ReleaseAndGetAddressOf( ) ) );
		}</span>
		// No more need to export symbols NvOptimusEnablement and AmdPowerXpressRequestHighPerformance
		DXGI_ADAPTER_DESC1 struAdapterDesc;
<span style = "background-color:#fdd">		HRESULT hr_ = m_pcDxgiFactory6 -&gt;EnumAdapterByGpuPreference(</span>
				  0
#ifdef _DEBUG
				// For my AMD Radeon most informative. Full compartible PIX, but disallow AltEnter
				, DXGI_GPU_PREFERENCE::DXGI_GPU_PREFERENCE_MINIMUM_POWER
#else // _DEBUG
				, DXGI_GPU_PREFERENCE::DXGI_GPU_PREFERENCE_HIGH_PERFORMANCE
#endif // _DEBUG
				, IID_PPV_ARGS( m_pcDxgiAdapter.ReleaseAndGetAddressOf( ) )
			);
		// if "Capture Adapter" when "Start Graphics Debugging"
<span style = "background-color:#fdd">		if ( FAILED( hr_ ) )
			hr = m_pcDxgiFactory6 -&gt;EnumAdapters1( 0, m_pcDxgiAdapter.ReleaseAndGetAddressOf( ) );
		hr = m_pcDxgiAdapter -&gt;GetDesc1( &amp;struAdapterDesc );</span>

<span style = "background-color:#fdd">		std::vector&lt; char &gt; plainMemory( ::wcslen( struAdapterDesc.Description ) + 1 );
		::wcstombs_s( nullptr, &amp;plainMemory[ 0 ], plainMemory.size( ), struAdapterDesc.Description, _TRUNCATE );
		m_strAdapterDescr = &amp;plainMemory[ 0 ];</span>

<span style = "background-color:#fdd">		return true;
	}
	operator IDXGIAdapter1 *() const {
		return m_pcDxgiAdapter.Get( );
	}
	IDXGIFactory6 *operator -&gt;() const {
		return m_pcDxgiFactory6.Get( );
	}
	std::string getDescrString() const {
		return m_strAdapterDescr;
	}</span>
};
} // namespace prj_3d::HelloWinHlsl::Dx::Adapter</pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>